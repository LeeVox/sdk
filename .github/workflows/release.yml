name: release

on:
  push:

env:
  VERSION: "5.0"

jobs:
  main:
    strategy:
      fail-fast: false
      matrix:
        os: ['windows-latest']
        sdk: ['5.0.100']
        config: ['Release']
        target: ['net5']
    runs-on: ${{ matrix.os }}
    steps:
      - name: get version
        id: get-version
        shell: pwsh
        run: |
          Write-Host ("::set-output name=VERSION::$env:VERSION." + ([math]::Round( [math]::Sqrt( ((Get-Date) - (Get-Date -Date "1/1/2020 0:0:0")).TotalMinutes ))))
      - name: checkout
        uses: actions/checkout@master
      - name: setup .netcore sdk
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: ${{ matrix.sdk }}
      - name: show info
        run: |
          echo sdk version
          dotnet --version
          echo branch '${{ github.ref }}', os '${{ matrix.os }}', sdk '${{ matrix.sdk }}', target '${{ matrix.target }}', config '${{ matrix.config }}'
          git log -3
      - name: build
        run: dotnet build LeeVox.Sdk -f ${{ matrix.target }} -c ${{ matrix.config }} /p:TargetFrameworks=${{ matrix.target }}
      - name: pack
        run: dotnet pack LeeVox.Sdk -c ${{ matrix.config }} --include-symbols /p:TargetFrameworks=${{ matrix.target }} /p:Version=$VERSION
      - name: create release
        uses: actions/create-release@v1
        with:
          tag_name: v$VERSION
          release_name: Version $VERSION
          draft: false
          pre_release: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.get-version.outputs.VERSION }}
      - name: publish nuget
        run: |
          dotnet nuget push LeeVox.Sdk\bin\${{ matrix.config }}\LeeVox.Sdk.$VERSION.symbols.nupkg --source https://api.nuget.org/v3/index.json --api-key $API_KEY
        env:
          API_KEY: ${{ secrets.LEEVOX_NUGET_API_KEY }}
          VERSION: ${{ steps.get-version.outputs.VERSION }}